{"ts":1370054950771,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n/*\n * JavaScript Redstone Simulator\n * Copyright (C) 2012  Jonathan Lydall (Email: jonathan.lydall@gmail.com)\n * \n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; either version 2\n * of the License, or (at your option) any later version.\n * \n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n * \n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA. \n * \n */\n\ninclude '../php/includes/class_schematicRetrieval.php';\ninclude '../php/includes/utf8_handling.php';\ninclude '../php/includes/googleAnalyticsScriptTagGenerator.php';\n\nfunction canDoDownload() {\n\t$referer = (isset($_SERVER['HTTP_REFERER'])) ? $_SERVER['HTTP_REFERER'] : \"\";\n\t$schematicId = (isset($_GET['downloadId'])) ? $_GET['downloadId'] : -1;\n\t$httpHost = $_SERVER['HTTP_HOST'];\n\t\n\treturn (\n\t\t$referer != \"\" &&\n\t\tstrpos($referer, \"http://\" . $httpHost) == 0 &&\n\t\t$schematicId >= 0 &&\n\t\tschematicRetrieval::checkExists($schematicId));\n}\n\nfunction doDownloadAndExit() {\n\t$fileMetadata = schematicRetrieval::getMetadata($_GET['downloadId']);\n\t$fileContents = schematicRetrieval::getFile($_GET['downloadId']);\n\t$fileSize = strval(strlen($fileContents));\n\t$fileName = $fileMetadata['fileName'];\n\t\n\theader('Content-Description: File Transfer');\n\theader('Content-Type: application/octet-stream');\n\theader('Content-Disposition: attachment; filename=' . $fileName . '.schematic');\n\theader('Content-Transfer-Encoding: binary');\n\theader('Expires: 0');\n\theader('Cache-Control: must-revalidate, post-check=0, pre-check=0');\n\theader('Pragma: public');\n\theader('Content-Length: ' . $fileSize);\n\t\n\techo $fileContents;\n\t\n\texit;\n}\n\nfunction id() {\n\tglobal $schematicMetadata;\n\techo htmlspecialchars($schematicMetadata['schematicId']);\n}\n\nfunction noRedirect() {\n\techo (isset($_GET['noRedirect'])) ? \"true\" : \"false\";\n}\n\nfunction author() {\n\tglobal $schematicMetadata;\n\techo htmlspecialchars($schematicMetadata['userDisplayName']);\n}\n\nfunction fileName() {\n\tglobal $schematicMetadata;\n\techo htmlspecialchars($schematicMetadata['fileName']) .\".schematic\";\n}\n\nif (canDoDownload()) {\n\tdoDownloadAndExit();\n}\nelse {\n\t$schematicMetadata = schematicRetrieval::getMetadata($_GET['downloadId']);\n}\n?>\n<!DOCTYPE html>\n<html> \n\t<head>\n\t\t<meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\" >\n\t\t<title>Javascript Redstone Simulator</title> \n\t\t<meta name=\"keywords\" content=\"\"> \n\t\t<meta name=\"description\" content=\"An in-browser, Javascript redstone simulator. Inspired by Baezon's simulator.\" />\n\t\t<style>\n\t\t\tbody {font-family: Arial};\n\t\t</style>\n<?php generateGaqScriptTag(); ?>\n\t</head>\n\t<body>\n\t\t<h1>Mordritch's Javascript Redstone Simulator</h1>\n<?php\n\tif (!$schematicMetadata['error']) {\n?>\n\t\t<div>\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\twindow.onload = function() {\n\t\t\t\t\tvar schematicId = <?php id(); ?>;\n\t\t\t\t\tvar noRedirect = <?php noRedirect(); ?>;\n\t\t\t\t\tif (!noRedirect) {\n\t\t\t\t\t\twindow.location.href = './?noRedirect=true&downloadId=' + schematicId;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t</script>\n\t\t\t<img src=\"../images/icons/download-2.png\" />\n\t\t\t<p>You are downloading <b><?php fileName(); ?></b> which was uploaded by <b><?php author(); ?></b> using <a href=\"../\">Mordritch's Javascript Redstone Simulator</a>.</p>\n\t\t\t<p>If the download does not start automatically, click <a href=\"./?downloadId=<?php id(); ?>\">here</a>.</p>\n\t\t\t<p>You can also view/edit the schematic online <a href=\"../#<?php id(); ?>\">here</a> from inside your web browser.</p>\n\t\t</div>\n<?php\n\t} else {\n?>\n\t\t<div>\n\t\t\t<p>No schematic found with the requested ID.</p>\n\t\t\t<p>Make your own schematic <a href=\"../\">here</a>.</p>\n\t\t</div>\n<?php\n\t}\n?>\t\t\n\t</body>\n</html>\n"]],"start1":0,"start2":0,"length1":0,"length2":4061}]],"length":4061}
